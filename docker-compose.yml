# Copyright (c) 2018, Juniper Networks, Inc.
# # All rights reserved.
#
version: "2.3"

services:

  vmx1:
    image: juniper/openjnpr-container-vmx:bionic
    privileged: true
    tty: true
    stdin_open: true
    ports:
      - "22"
      - "830"
      - "50051"
    container_name: vmx1
    environment:
      - ID=vmx1
      - LICENSE=license-eval.txt
      - IMAGE=junos-vmx-x86-64-18.3R1.9.qcow2
      - PUBLICKEY=id_rsa.pub
      - CONFIG=vmx1.conf
      - YANG_PACKAGE=lwaftr
      - YANG_SCHEMA=snabb-softwire-v2.yang ietf-inet-types.yang ietf-yang-types.yang
    volumes:
      - $PWD:/u:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      mgmt:
      net-macvlan:

  snabb-config:
    build: snabb-config
    tty: true
    stdin_open: true
    restart: always
    command: config listen lwaftr
    environment:
      - PORT=4321
    ports:
      - "4321"
    volumes:
      - /run/snabb:/run/snabb
    depends_on:
      - "vmx1"
    networks:
      mgmt:

  veth-links:
    build: veth-links
    privileged: true
    network_mode: "service:vmx1"
    restart: on-failure
    environment:
      - LINKCOUNT=8
      - CONTAINER=vmx1
    depends_on:
      - "vmx1"

  snabbvmx:
    build: snabbvmx
    tty: true
    stdin_open: true
    entrypoint: /bin/ash
    #command: 
    restart: on-failure
    volumes:
      - $PWD:/u     # FIXME: not required in production
    depends_on:
      - "vmx1"
    networks:
      mgmt:

  jroutes:
    build: jroutes
    tty: true
    stdin_open: true
    #entrypoint: /bin/ash
    command: --ipv4plen 29 --ipv6plen 64 -s 4321 -g vmx1 -P 50051 -u root snabb-config
    restart: on-failure
    volumes:
      - $PWD:/u:ro
    depends_on:
      - "snabb-config"
      - "vmx1"
    networks:
      mgmt:

#  snabb-get-state:
#    build: snabb-config
#    pid: "service:lwaftr"
#    tty: true
#    stdin_open: true
#    #    restart: always
#    command: config get-state -s snabb-softwire-v2 lwaftr
#    #entrypoint: /bin/ash
#    environment:
#      - PORT=4322
#    ports:
#      - "4322"
#    volumes:
#      - snabb-run:/run
#    depends_on:
#      - "lwaftr"

networks:
  mgmt:
  net-macvlan:
    driver: macvlan
    driver_opts:
      parent: enp0s25
